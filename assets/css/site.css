/* site.js â€” dropdown behavior (desktop hover + touch click), no auto-refresh */

const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

document.addEventListener('DOMContentLoaded', () => {
  const dropdowns = $$('.navbar .dropdown');
  const closeTimers = new WeakMap();

  // Detect desktop vs touch/pointer
  const mql = window.matchMedia('(hover: hover) and (pointer: fine)');
  let isDesktop = mql.matches;
  if (mql.addEventListener) {
    mql.addEventListener('change', e => { isDesktop = e.matches; closeAll(); });
  } else if (mql.addListener) {
    mql.addListener(e => { isDesktop = e.matches; closeAll(); });
  }

  function openDropdown(drop) {
    dropdowns.forEach(d => { if (d !== drop) closeDropdown(d, 0); });
    const panel = drop.querySelector('.dropdown-content');
    if (!panel) return;
    clearTimeout(closeTimers.get(drop));
    panel.style.display = 'block';
    drop.classList.add('open');
    drop.setAttribute('aria-expanded', 'true');
  }

  function scheduleClose(drop, delay = 140) {
    clearTimeout(closeTimers.get(drop));
    const t = setTimeout(() => closeDropdown(drop, 0), delay);
    closeTimers.set(drop, t);
  }

  function closeDropdown(drop, delay = 0) {
    clearTimeout(closeTimers.get(drop));
    const panel = drop.querySelector('.dropdown-content');
    if (!panel) return;
    if (delay > 0) return scheduleClose(drop, delay);
    panel.style.display = 'none';
    drop.classList.remove('open');
    drop.setAttribute('aria-expanded', 'false');
  }

  function closeAll() {
    dropdowns.forEach(d => closeDropdown(d, 0));
  }

  dropdowns.forEach(drop => {
    const trigger = drop.querySelector(':scope > a');
    const panel = drop.querySelector('.dropdown-content');

    // Desktop hover
    drop.addEventListener('mouseenter', () => { if (isDesktop) openDropdown(drop); });
    drop.addEventListener('mouseleave', () => { if (isDesktop) scheduleClose(drop, 140); });

    if (panel) {
      panel.addEventListener('mouseenter', () => { if (isDesktop) clearTimeout(closeTimers.get(drop)); });
      panel.addEventListener('mouseleave', () => { if (isDesktop) scheduleClose(drop, 140); });
    }

    // Keyboard focus
    drop.addEventListener('focusin', () => openDropdown(drop));
    drop.addEventListener('focusout', () => {
      setTimeout(() => {
        if (!drop.contains(document.activeElement)) closeDropdown(drop, 0);
      }, 150);
    });

    // Touch
    if (trigger) {
      trigger.addEventListener('click', (e) => {
        if (isDesktop) return;
        const isOpen = drop.classList.contains('open') || (panel && panel.style.display === 'block');
        if (!isOpen) {
          e.preventDefault();
          openDropdown(drop);
        } else {
          closeAll();
        }
      });
    }
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.navbar .dropdown')) closeAll();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAll();
  });
});
`
